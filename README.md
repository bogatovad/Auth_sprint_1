## Ссылка на репозиторий
https://github.com/bogatovad/Auth_sprint_1

Авторы:
 - [bogatovad](https://github.com/bogatovad)
 - [Seniacat](https://github.com/Seniacat)
 - [acetone415](https://github.com/acetone415)


# Сервис аутентификации и авторизации


## Возможности сервиса

- регистрация пользователя;
- вход пользователя в аккаунт (обмен логина и пароля на пару токенов: JWT-access токен и refresh токен);
- обновление access и refresh токенов;
- выход пользователя из аккаунта;
- изменение логина или пароля;
- получение пользователем своей истории входов в аккаунт;
- регистрация и аутентефикация через социальные сервисы.


## Используемые технологии

- Flask
- PostgreSQL
- Redis
- Docker
- Pytest
- SQLAlchemy

## Запуск

Создать и заполнить .env из .env.example в папке `Auth_sprint_1/envs`.
Из этой папки `Auth_sprint_1` выполнить:
```
make start
```

## Запуск тестов

Из контейнера flask (`auth_sprint_1_auth_1`) запустить pytest:
```
docker exec -it auth_sprint_1_auth_1 bash

pytest
```


## Создание суперпользователя

Из контейнера flask (`auth_sprint_1_auth_1`) запустить
```
flask --app main.py create-superuser admin pass email
```

## Документация API

Доступна по адресу `http://host:port/apidocs`

### Описание
    запросы к API начинаются с `/api/v1/`

    Auth API для сервиса movies реализует регистрацию и аутентификацию пользователей, в том числе через социальные сервисы Yandex и Vkontakte.
    Пользователь может посмотреть историю своих входов с различных устройств, изменить учетные данные, открепить аккаунт в соцсети от личного кабинета.
    Администратор может создавать и удалять ролт, назначать роли пользователям.
    # Регистрация и аутентификация пользователей
    1. Пользователь регистрируется на `/auth/signup/`, вводя login, email и пароль 
    2. Пользователь вводит свои учетные данные на `/auth/login/ (login и password ) и получает access token и refresh token.
    3. Если access токен истек, обновить его множно на `/auth/refresh/`
    4. Вывести историю входов пользователь может на `/users/history_auth/` при наличии валидного access токена
    
    # Роли
    - Anonimous — может просматривать список фильмов, информацию о жанрах и персонах, пользоваться поиском. Не может просматривать детальное описания фильмов.
    - User — может просматривать список фильмов, информацию о жанрах и персонах, пользоваться поиском, изменять учетные данные, просматривать историю посещений. Не может просматривать детальное описания фильмов.
    - Subscriber - права такие же, как у роли User, но может просматривать детальную информацию о фильмах.
    - Admin — может создавать, изменять и удалять роли пользователей, назначать их пользователям и отзывать.

    ![Схема взаимодействия сервисов](src\project_info\services_scheme.jpg)

    1. К защищенному эндпойнту Movies Async API приходит запрос от пользователя
    2. Если в запросе от пользователя нет заголовка Authorization с aссess токеном, пользователь считается анонимным (Anonimous).
    3. При наличии токена в заголовке сервис Movies Async API делает get запрос к Auth API на `role/user/roles/` с пришедшим токеном в заголовке Authorization.
    4. Auth API проверяет access token в Redis среди отозванных токенов, а так же проверяет валидность токена.
    5. Если токен валиден, сервис Movies Async API получает список ролей пользователя и проверяет доступ к запрашиваемому эндпойнту для данной роли
    6. Если токен невалиден, доступ пользователю запрещен.
    7. Определение того, какие роли имеют доступ к тем или иным эндпойнтам лежит на сервисе Movies Async API.

